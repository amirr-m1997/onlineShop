{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% block content %}
    <!-- Header-->
    <!-- Header-->
    <header class="bg-dark py-3">
        <div class="container px-4 px-lg-5 my-4">
            <div class="text-center text-white">
                <h2 class="display-5 fw-bolder">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h2>
                <p class="lead fw-normal text-white-50 mb-0">Ø³Ø§ÛŒØª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ </p>
            </div>
        </div>
    </header>
    <br>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    {% if request.GET.message == 'deleted' %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert" id="delete-message">
            Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø­Ø°Ù Ø´Ø¯.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}
    {% if cart_products %}
        {% for product in cart_products %}
            <div class="container">
                <br>
                <div class="card mb-3 shadow">
                    <div class="row g-0">
                        <div class="col-md-4">
                            <img src="{{ product.picture.url }}" class="img-fluid rounded-start"
                                 alt="{{ product.name }}">
                        </div>
                        <div class="col-md-8">
                            <div class="badge bg-dark text-white position-absolute" style="top: 0.5rem; right: 0.5rem">
                                ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">{{ product.description |safe }}</p>
                                {% if product.is_sale %}
                                    <p class="card-text"> ğŸ’° Ù‚ÛŒÙ…Øª Ø¨Ø§ ØªØ®ÙÛŒÙ : <strike
                                            style="color: red"> {{ product.price|floatformat:3|intcomma }}</strike>
                                        - {{ product.sale_price|floatformat:3|intcomma }}</p>
                                {% else %}
                                    <p class="card-text">{{ product.price|floatformat:3|intcomma }} ØªÙˆÙ…Ø§Ù† </p>
                                {% endif %}
                                <p class="card-text">ØªØ¹Ø¯Ø§Ø¯ :
                                    {% for key, value in quantities.items %}
                                        {% if key == product.id|stringformat:"s" %}
                                            {{ value.quantity }}
                                        {% endif %}
                                    {% endfor %}
                                </p>

                                <p class="card-text">Ø±Ù†Ú¯ :
                                    {% for key, value in color.items %}
                                        {% if key == product.id|stringformat:"s" %}
                                            {{ value.color }}
                                        {% endif %}
                                    {% endfor %}
                                </p>
                                <p class="card-text">Ø§Ù†Ø¯Ø§Ø²Ù‡ :
                                    {% for key, value in size.items %}
                                        {% if key == product.id|stringformat:"s" %}
                                            {{ value.size }}
                                        {% endif %}
                                    {% endfor %}
                                </p>

                                <div class="d-flex" dir="ltr">
                                    <form action="{% url 'cart_delete' %}" method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="product_id" value="{{ product.id }}">
                                        <button type="submit" class="btn btn-danger">
                                            Ø­Ø°Ù
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal"
                                            data-bs-target="#editModal{{ product.id }}">
                                        ÙˆÛŒØ±Ø§ÛŒØ´
                                    </button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Modal -->
            <!-- Edit Modal -->
            <!-- Edit Modal -->
            <!-- Edit Modal -->
            <div class="modal fade" id="editModal{{ product.id }}" tabindex="-1"
                 aria-labelledby="editModalLabel{{ product.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-dark text-white">
                            <h5 class="modal-title" id="editModalLabel{{ product.id }}"
                                style="display: flex; align-items: center;">
                                <i class="fas fa-edit me-2"></i>
                                ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„
                            </h5>

                        </div>
                        <div class="modal-body">
                            <form id="edit-form-{{ product.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="product_id" value="{{ product.id }}">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="quantity-{{ product.id }}" class="form-label">ØªØ¹Ø¯Ø§Ø¯</label>
                                            <select class="form-select" id="quantity-{{ product.id }}" name="quantity"
                                                    required>
                                                {% for tedad in tedads %}
                                                    <option value="{{ tedad.name }}">{{ tedad.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="size-{{ product.id }}" class="form-label">Ø³Ø§ÛŒØ²</label>
                                            <select class="form-select" id="size-{{ product.id }}" name="size" required>
                                                {% for size in sizes %}
                                                    <option value="{{ size.name }}">{{ size.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="color-{{ product.id }}" class="form-label">Ø±Ù†Ú¯</label>
                                            <select class="form-select" id="color-{{ product.id }}" name="color"
                                                    required>
                                                {% for color in colors %}
                                                    <option value="{{ color.name }}">{{ color.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
                            <button type="button" class="btn btn-success save-changes-btn"
                                    data-product-id="{{ product.id }}">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        <!-- Ø¨Ø®Ø´ Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª -->

        <div class="container mt-4">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card text-center border border-secondary shadow">
                        <div class="card-body">
                            <h5 class="card-text text-primary"> ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„ Ù…Ø­ØµÙˆÙ„Ø§Øª : </h5>
                            <h6 class="card-text text-success"> {{ total_products }}</h6>
                            <h5 class="card-title text-primary">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª :</h5>
                            <h6 class="card-text text-success">{{ total_price | intcomma }} ØªÙˆÙ…Ø§Ù†</h6>
                            <div class="mt-3" dir="ltr">
                                <button type="button" class="btn btn-dark btn-sm" onclick="window.location.href='/'">
                                    <i class="fas fa-arrow-left"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Ù…Ø­ØµÙˆÙ„
                                </button>
                                <!-- Ø¯Ø± ÙØ±Ù… Ø§ØµÙ„ÛŒ -->
                                <!-- Ù‚Ø§Ù„Ø¨ Ù‚Ø¨Ù„ÛŒØŒ Ù…Ø«Ù„Ø§Ù‹ product.html -->
                                <button type="button" id="continue-shopping" class="btn btn-primary btn-sm"
                                        onclick="window.location.href='{% url 'order' %}'">
                                    <i class="fas fa-shopping-cart"></i> Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯
                                </button>
                                <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù…ÙˆØ¯Ø§Ù„ -->


                                {#                                <form id="paymentForm" method="POST" action="{% url 'payment_process' %}">#}
                                {#                                    {% csrf_token %}#}
                                {#                                    <button type="submit" class="btn btn-primary btn-sm">#}
                                {#                                        <i class="fas fa-shopping-cart"></i> Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯#}
                                {#                                    </button>#}
                                {#                                </form>#}
                            </div>

                        </div>
                    </div>
                    <br>
                    <br>
                </div>
            </div>
        </div>
        <!-- Ù¾Ù†Ø¬Ø±Ù‡ Ù…ÙˆØ¯Ø§Ù„ -->
        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalLabel">Ø®Ø·Ø§</h5>
                        {#                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Ø¨Ø³ØªÙ†"></button>#}
                    </div>
                    <div class="modal-body text-danger">
                        Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø³Ø§ÛŒØª Ø´ÙˆÛŒØ¯.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="loginButton">ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯</button>
                        <button type="button" class="btn btn-primary" id="registerButton">Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ù†ÛŒØ¯</button>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <center><h3 class="container" style="color: red">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø´Ù…Ø§ Ø®Ø§Ù„ÛŒØ³Øª! &#128531;</h3></center>
    {% endif %}
    <br>
    <script>
        function updateCartItem(productId, quantity, size, color) {
            $.ajax({
                url: '{% url 'cart_update' %}',
                type: 'POST',
                data: {
                    'product_id': productId,
                    'quantity': quantity,
                    'size': size,
                    'color': color,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function (response) {
                    if (response.success) {
                        alert('ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
                        $('#editModal' + productId).modal('hide');
                        location.reload(); // Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² ÙˆÛŒØ±Ø§ÛŒØ´
                    } else {
                        alert(response.error);
                    }
                },
                error: function (xhr, status, error) {
                    alert('Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.');
                }
            });
        }

        $(document).ready(function () {
            $('.save-changes-btn').click(function () {
                var productId = $(this).data('product-id');
                var quantity = $('#quantity-' + productId).val();
                var size = $('#size-' + productId).val();
                var color = $('#color-' + productId).val();

                updateCartItem(productId, quantity, size, color);
            });
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var deleteMessage = document.getElementById("delete-message");
            if (deleteMessage) {
                setTimeout(function () {
                    deleteMessage.classList.remove('show');
                }, 3000);
            }
        });
    </script>
    {#    Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø± Ø³Ø§ÛŒØª Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡ ÛŒØ§ Ù†Ù‡#}
    <script>
        document.getElementById('continue-shopping').onclick = function () {
            var isAuthenticated = "{{ user.is_authenticated }}";

            if (isAuthenticated === "True") {
                window.location.href = "{% url 'order' %}";
            } else {
                var myModal = new bootstrap.Modal(document.getElementById('loginModal'), {
                    keyboard: false
                });
                myModal.show();
            }
        };
    </script>
{#    Ø¢Ø¯Ø±Ø³ ØµÙØ­Ø§Øª Ø«Ø¨Øª Ù†Ø§Ù… Ùˆ Ù„Ø§Ú¯ÛŒÙ†#}
    <script>
        document.getElementById('loginButton').onclick = function () {
            window.location.href = "{% url 'login' %}";
        };
        document.getElementById('registerButton').onclick = function () {
            window.location.href = "{% url 'register' %}";
        };
    </script>

{% endblock %}
